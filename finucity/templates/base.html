<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Finucity - Your AI-powered Chartered Accountant providing instant, accurate financial guidance and tax advice">
    <meta name="keywords" content="AI financial advisor, tax planning, investment guidance, GST compliance, business finance, financial assistant">
    <meta name="author" content="Sumeet Sangwan">
    <meta property="og:title" content="Finucity - Your Trusted AI Chartered Accountant">
    <meta property="og:description" content="Get instant, accurate financial guidance with our AI-powered financial assistant">
    <meta property="og:image" content="{{ url_for('static', filename='images/og-image.jpg') }}">
    <meta property="og:url" content="{{ request.url }}">
    <meta name="twitter:card" content="summary_large_image">
    
    <title>{% block title %}Finucity - Your Trusted AI Chartered Accountant{% endblock %}</title>
    
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="{{ url_for('static', filename='images/apple-touch-icon.png') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">
    <link rel="icon" type="image/png" sizes="16x16" href="{{ url_for('static', filename='images/favicon-16x16.png') }}">
    <link rel="manifest" href="{{ url_for('static', filename='images/site.webmanifest') }}">
    <link rel="mask-icon" href="{{ url_for('static', filename='images/safari-pinned-tab.svg') }}" color="#fba002">
    <meta name="msapplication-TileColor" content="#fba002">
    <meta name="theme-color" content="#313b2f">
    
    <!-- Preload Critical Assets -->
    <link rel="preload" href="{{ url_for('static', filename='css/style.css') }}" as="style">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Bootstrap CSS (optional, for modals and other components) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/premium.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/premium-components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/premium-advanced.css') }}">
    
    <!-- Page-specific CSS -->
    {% block extra_css %}{% endblock %}
    
    <!-- Analytics: Configure GTM_ID in environment to enable -->
    {% if config.get('GTM_ID') %}
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','{{ config.get("GTM_ID") }}');</script>
    {% endif %}
</head>
<body>
    {% if config.get('GTM_ID') %}
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id={{ config.get('GTM_ID') }}"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    {% endif %}
    
    <!-- Scroll Progress Bar -->
    <div class="scroll-progress" id="scrollProgress"></div>
    
    <!-- Animated Mesh Background -->
    <div class="mesh-background">
        <div class="mesh-gradient"></div>
    </div>
    
    <!-- Enhanced Navigation -->
    <nav class="navbar" id="navbar">
        <div class="nav-container container">
            <a href="{{ url_for('main.home') }}" class="logo">
                <img src="{{ url_for('static', filename='images/Logo.png') }}" alt="Finucity Logo" width="40" height="40">
                <span class="logo-text">Finucity</span>
            </a>
            
            <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle navigation menu">
                <i class="fas fa-bars"></i>
            </button>
            
            <ul class="nav-links" id="navLinks">
                <li><a href="{{ url_for('main.home') }}" class="{% if request.path == url_for('main.home') %}active{% endif %}">Home</a></li>
                <li><a href="{{ url_for('main.about') }}" class="{% if request.path == url_for('main.about') %}active{% endif %}">About</a></li>
                <li><a href="#faq" class="js-scroll-trigger">FAQ</a></li>
                
                {% if current_user.is_authenticated %}
                    {% if current_user.is_admin %}
                    <li><a href="{{ url_for('main.admin_dashboard') }}" class="{% if request.path == url_for('main.admin_dashboard') %}active{% endif %}">Admin Dashboard</a></li>
                    {% endif %}
                    
                    {% if current_user.role == 'ca_pending' %}
                    <li><a href="{{ url_for('main.ca_application_status') }}" class="{% if request.path == url_for('main.ca_application_status') %}active{% endif %}">Application Status</a></li>
                    {% elif current_user.role == 'user' %}
                    <li><a href="{{ url_for('main.ca_application') }}" class="{% if request.path == url_for('main.ca_application') %}active{% endif %}">Become a CA</a></li>
                    {% elif current_user.role == 'ca' %}
                    <li><a href="{{ url_for('main.ca_dashboard') }}" class="{% if request.path == url_for('main.ca_dashboard') %}active{% endif %}">CA Dashboard</a></li>
                    {% endif %}
                <li class="dropdown user-dropdown">
                        <a href="#" class="dropdown-toggle user-dropdown-toggle">
                            <span class="user-avatar">{{ current_user.first_name[0]|upper }}{{ current_user.last_name[0]|upper }}</span>
                            <span class="user-name d-none d-md-inline">{{ current_user.first_name }}</span>
                            <i class="fas fa-chevron-down"></i>
                        </a>
                        <div class="dropdown-menu user-menu">
                            <div class="user-menu-header">
                                <div class="user-menu-avatar">{{ current_user.first_name[0]|upper }}{{ current_user.last_name[0]|upper }}</div>
                                <div class="user-menu-info">
                                    <h4>{{ current_user.full_name }}</h4>
                                    <p>{{ current_user.email }}</p>
                                </div>
                            </div>
                            <div class="user-menu-divider"></div>
                            <a href="{{ url_for('main.home') }}" class="dropdown-item">
                                <i class="fas fa-home"></i> Home
                            </a>
                            {% if current_user.is_admin %}
                            <a href="{{ url_for('main.admin_dashboard') }}" class="dropdown-item">
                                <i class="fas fa-shield-alt"></i> Admin Dashboard
                            </a>
                            {% endif %}
                            {% if current_user.role == 'ca' %}
                            <a href="{{ url_for('main.ca_dashboard') }}" class="dropdown-item">
                                <i class="fas fa-briefcase"></i> CA Dashboard
                            </a>
                            {% elif current_user.role == 'user' %}
                            <a href="{{ url_for('main.user_dashboard') }}" class="dropdown-item">
                                <i class="fas fa-th-large"></i> Dashboard
                            </a>
                            {% endif %}
                            {% if current_user.role == 'ca_pending' %}
                            <a href="{{ url_for('main.ca_application_status') }}" class="dropdown-item">
                                <i class="fas fa-clock"></i> Application Status
                            </a>
                            {% endif %}
                            <a href="{{ url_for('main.profile') }}" class="dropdown-item">
                                <i class="fas fa-user"></i> My Profile
                            </a>
                            <a href="{{ url_for('chat.chat_interface') }}" class="dropdown-item">
                                <i class="fas fa-robot"></i> AI Chat
                            </a>
                            <a href="{{ url_for('chat.chat_history') }}" class="dropdown-item">
                                <i class="fas fa-history"></i> Chat History
                            </a>
                            <div class="user-menu-divider"></div>
                            <a href="{{ url_for('auth.logout') }}" class="dropdown-item text-danger">
                                <i class="fas fa-sign-out-alt"></i> Logout
                            </a>
                        </div>
                    </li>
                {% else %}
                    <li><a href="{{ url_for('auth.login') }}" class="login-btn">Login</a></li>
                    <li><a href="{{ url_for('chat.chat_interface') }}" class="cta-button">Try Now <i class="fas fa-arrow-right"></i></a></li>
                {% endif %}
            </ul>
        </div>
    </nav>

    <main>
        <!-- Page-specific content -->
        {% block content %}{% endblock %}
    </main>

    {% include 'footer.html' %}

    <!-- Preload JavaScript Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
    <script src="{{ url_for('static', filename='js/main.js') }}" defer></script>
    <script src="{{ url_for('static', filename='js/premium-advanced.js') }}" defer></script>
    
    <!-- Base JavaScript -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile navigation toggle
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const navLinks = document.getElementById('navLinks');
            
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', function() {
                    navLinks.classList.toggle('active');
                    this.classList.toggle('active');
                    
                    // Update icon
                    const icon = this.querySelector('i');
                    if (navLinks.classList.contains('active')) {
                        icon.classList.remove('fa-bars');
                        icon.classList.add('fa-times');
                    } else {
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });
            }
            
            // Close mobile menu when clicking on a link
            const navLinksItems = document.querySelectorAll('.nav-links > li > a:not(.dropdown-toggle)');
            navLinksItems.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth <= 768) {
                        navLinks.classList.remove('active');
                        mobileMenuBtn.classList.remove('active');
                        const icon = mobileMenuBtn.querySelector('i');
                        icon.classList.remove('fa-times');
                        icon.classList.add('fa-bars');
                    }
                });
            });
            
            // Dropdown functionality
            const dropdowns = document.querySelectorAll('.dropdown');
            dropdowns.forEach(dropdown => {
                const toggle = dropdown.querySelector('.dropdown-toggle');
                
                if (toggle) {
                    toggle.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Toggle current dropdown
                        dropdown.classList.toggle('active');
                        
                        // Close other open dropdowns
                        dropdowns.forEach(otherDropdown => {
                            if (otherDropdown !== dropdown && otherDropdown.classList.contains('active')) {
                                otherDropdown.classList.remove('active');
                            }
                        });
                    });
                }
            });
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown')) {
                    dropdowns.forEach(dropdown => {
                        dropdown.classList.remove('active');
                    });
                }
            });
            
            // Prevent dropdown from closing when clicking inside dropdown menu
            const dropdownMenus = document.querySelectorAll('.dropdown-menu');
            dropdownMenus.forEach(menu => {
                menu.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            });
            
            // Handle scroll to anchor links
            const scrollTriggers = document.querySelectorAll('.js-scroll-trigger');
            scrollTriggers.forEach(trigger => {
                trigger.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    
                    // Check if target exists on current page
                    const targetElement = document.querySelector(targetId);
                    
                    if (targetElement) {
                        // Close mobile menu if open
                        if (window.innerWidth <= 768) {
                            navLinks.classList.remove('active');
                            mobileMenuBtn.classList.remove('active');
                            const icon = mobileMenuBtn.querySelector('i');
                            icon.classList.remove('fa-times');
                            icon.classList.add('fa-bars');
                        }
                        
                        // Smooth scroll to target
                        window.scrollTo({
                            top: targetElement.offsetTop - 100,
                            behavior: 'smooth'
                        });
                    } else {
                        // If target doesn't exist on current page, navigate to home with anchor
                        window.location.href = "{{ url_for('main.home') }}" + targetId;
                    }
                });
            });
            
            // Notification banner
            const notificationBanner = document.getElementById('notificationBanner');
            const closeBanner = document.getElementById('closeBanner');
            
            if (closeBanner && notificationBanner) {
                closeBanner.addEventListener('click', function() {
                    notificationBanner.style.display = 'none';
                    // Save preference in local storage with timestamp
                    const closeTime = new Date().getTime();
                    localStorage.setItem('bannerClosed', closeTime.toString());
                });
                
                // Check if banner was previously closed (show again after 7 days)
                const bannerClosedTime = localStorage.getItem('bannerClosed');
                if (bannerClosedTime) {
                    const currentTime = new Date().getTime();
                    const sevenDays = 7 * 24 * 60 * 60 * 1000; // 7 days in milliseconds
                    
                    if (currentTime - parseInt(bannerClosedTime) < sevenDays) {
                        notificationBanner.style.display = 'none';
                    }
                }
            }
            
            // Navbar scroll effect with smart hide/show
            const navbar = document.getElementById('navbar');
            let lastScrollTop = 0;
            let scrollTimeout;
            
            window.addEventListener('scroll', function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                // Clear previous timeout
                clearTimeout(scrollTimeout);
                
                if (scrollTop > 80) {
                    navbar.classList.add('scrolled');
                    
                    if (scrollTop > lastScrollTop && scrollTop > 300) {
                        // Scrolling down and past threshold - hide navbar
                        navbar.classList.add('navbar-hidden');
                    } else {
                        // Scrolling up - show navbar
                        navbar.classList.remove('navbar-hidden');
                    }
                } else {
                    navbar.classList.remove('scrolled');
                    navbar.classList.remove('navbar-hidden');
                }
                
                // Show navbar briefly when scroll stops
                scrollTimeout = setTimeout(() => {
                    navbar.classList.remove('navbar-hidden');
                }, 1000);
                
                lastScrollTop = scrollTop <= 0 ? 0 : scrollTop;
            });
            
            // Initialize Bootstrap tooltips and popovers
            if (typeof bootstrap !== 'undefined') {
                const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
                const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
                
                const popoverTriggerList = document.querySelectorAll('[data-bs-toggle="popover"]');
                const popoverList = [...popoverTriggerList].map(popoverTriggerEl => new bootstrap.Popover(popoverTriggerEl));
            }
            
            // Add active class to current page navigation link
            const currentPath = window.location.pathname;
            const navLinksAll = document.querySelectorAll('.nav-links a');
            
            navLinksAll.forEach(link => {
                if (link.getAttribute('href') === currentPath) {
                    link.classList.add('active');
                }
            });
            
            // Add smooth reveal animation to elements as they come into view
            const observerOptions = {
                threshold: 0.1,
                rootMargin: '0px 0px -50px 0px'
            };
            
            const observer = new IntersectionObserver(function(entries) {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate-in');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);
            
            // Observe all elements with fade-in class
            const animatedElements = document.querySelectorAll('.fade-in, .service-card, .feature-card');
            animatedElements.forEach(el => observer.observe(el));
        });
        
        // Handle browser back button
        window.addEventListener('popstate', function(event) {
            // Refresh page on back button to ensure proper state
            location.reload();
        });
        
        // Add page visibility change handler
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // Page is hidden - user switched tabs
                console.log('User left the page');
            } else {
                // Page is visible again
                console.log('User returned to the page');
            }
        });
    </script>
    
    <!-- Page-specific JavaScript -->
    {% block extra_js %}{% endblock %}
    
    <!-- Global notification system -->
    <script>
        // Global toast notification function
        window.showToast = function(message, type = 'info', duration = 3000) {
            // Create toast container if it doesn't exist
            let toastContainer = document.getElementById('globalToastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'globalToastContainer';
                toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 10000;';
                document.body.appendChild(toastContainer);
            }
            
            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.style.cssText = `
                background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : '#2196F3'};
                color: white;
                padding: 16px 24px;
                margin-bottom: 10px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                animation: slideInRight 0.3s ease-out;
                max-width: 350px;
                word-wrap: break-word;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 12px;">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
            `;
            
            toastContainer.appendChild(toast);
            
            // Auto remove after duration
            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, duration);
        };
        
        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from {
                    transform: translateX(400px);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            @keyframes slideOutRight {
                from {
                    transform: translateX(0);
                    opacity: 1;
                }
                to {
                    transform: translateX(400px);
                    opacity: 0);
                }
            }
            
            .animate-in {
                animation: fadeInUp 0.6s ease-out forwards;
            }
            
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>