<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Services | Finucity Admin</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin-dashboard.css') }}">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ url_for('static', filename='images/favicon-32x32.png') }}">
</head>
<body class="admin-shell">

<div class="admin-layout" id="adminLayout">

    <!-- ===== SIDEBAR ===== -->
    <aside class="admin-sidebar" id="adminSidebar">
        <div class="sidebar-brand">
            <div class="sidebar-brand-icon">F</div>
            <div class="sidebar-brand-text">
                <h1>Finucity</h1>
                <span>Admin Panel</span>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="sidebar-section">
                <div class="sidebar-section-label">Overview</div>
                <a href="{{ url_for('main.admin_dashboard') }}" class="sidebar-link">
                    <i class="fas fa-th-large"></i>
                    <span class="link-text">Dashboard</span>
                </a>
                <a href="{{ url_for('admin_enhanced.analytics') }}" class="sidebar-link">
                    <i class="fas fa-chart-line"></i>
                    <span class="link-text">Analytics</span>
                </a>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-label">People</div>
                <a href="{{ url_for('main.admin_users') }}" class="sidebar-link">
                    <i class="fas fa-users"></i>
                    <span class="link-text">Users</span>
                </a>
                <a href="{{ url_for('main.admin_ca_applications') }}" class="sidebar-link">
                    <i class="fas fa-user-tie"></i>
                    <span class="link-text">CA Applications</span>
                </a>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-label">Operations</div>
                <a href="{{ url_for('admin_enhanced.manage_services') }}" class="sidebar-link active">
                    <i class="fas fa-concierge-bell"></i>
                    <span class="link-text">Services</span>
                </a>
                <a href="{{ url_for('admin_enhanced.manage_bookings') }}" class="sidebar-link">
                    <i class="fas fa-receipt"></i>
                    <span class="link-text">Bookings</span>
                </a>
                <a href="{{ url_for('admin_enhanced.manage_pricing') }}" class="sidebar-link">
                    <i class="fas fa-tags"></i>
                    <span class="link-text">Pricing</span>
                </a>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-label">Moderation</div>
                <a href="{{ url_for('admin_enhanced.manage_disputes') }}" class="sidebar-link">
                    <i class="fas fa-gavel"></i>
                    <span class="link-text">Disputes</span>
                </a>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-section-label">System</div>
                <a href="{{ url_for('admin_enhanced.platform_settings') }}" class="sidebar-link">
                    <i class="fas fa-cog"></i>
                    <span class="link-text">Settings</span>
                </a>
                <a href="{{ url_for('main.home') }}" class="sidebar-link">
                    <i class="fas fa-external-link-alt"></i>
                    <span class="link-text">View Site</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="sidebar-user" onclick="window.location.href='/profile'">
                <div class="sidebar-user-avatar">AD</div>
                <div class="sidebar-user-info">
                    <h4>Administrator</h4>
                    <span>Admin Panel</span>
                </div>
            </div>
            <button class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar">
                <i class="fas fa-chevron-left"></i>
            </button>
        </div>
    </aside>

    <!-- ===== HEADER ===== -->
    <header class="admin-header">
        <div class="header-left">
            <button class="mobile-sidebar-toggle" id="mobileSidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="header-breadcrumb">
                <span>Admin</span>
                <i class="fas fa-chevron-right"></i>
                <span>Operations</span>
                <i class="fas fa-chevron-right"></i>
                <span class="breadcrumb-current">Services</span>
            </div>
        </div>
        <div class="header-right">
            <div class="live-indicator">
                <span class="live-dot"></span>
                <span>Live</span>
            </div>
            <div class="header-divider"></div>
            <a href="{{ url_for('auth.logout') }}" class="header-icon-btn" title="Logout">
                <i class="fas fa-sign-out-alt"></i>
            </a>
        </div>
    </header>

    <!-- ===== MAIN CONTENT ===== -->
    <main class="admin-main">

        <!-- Page Title -->
        <div class="page-title-bar">
            <div class="page-title-group">
                <h2>Service Catalog</h2>
                <p>{{ services|length }} services across {{ categorized|length }} categories</p>
            </div>
            <div class="page-actions">
                <a href="{{ url_for('admin_enhanced.manage_pricing') }}" class="btn-admin secondary">
                    <i class="fas fa-tags"></i> Pricing
                </a>
                <a href="{{ url_for('admin_enhanced.create_service') }}" class="btn-admin primary">
                    <i class="fas fa-plus"></i> Add Service
                </a>
            </div>
        </div>

        <!-- ===== STATS ROW ===== -->
        <div class="stats-row">
            <div class="stat-card" style="--card-accent: #3b82f6;">
                <div class="stat-card-header">
                    <span class="stat-card-label">Total Services</span>
                    <div class="stat-card-icon info"><i class="fas fa-concierge-bell"></i></div>
                </div>
                <div class="stat-card-value">{{ services|length }}</div>
                <div class="stat-card-change neutral"><i class="fas fa-layer-group"></i> {{ categorized|length }} categories</div>
            </div>

            <div class="stat-card" style="--card-accent: #22c55e;">
                <div class="stat-card-header">
                    <span class="stat-card-label">Active</span>
                    <div class="stat-card-icon success"><i class="fas fa-toggle-on"></i></div>
                </div>
                <div class="stat-card-value">{{ services|selectattr('is_active')|list|length }}</div>
                <div class="stat-card-change up"><i class="fas fa-check-circle"></i> Available to users</div>
            </div>

            <div class="stat-card" style="--card-accent: #f59e0b;">
                <div class="stat-card-header">
                    <span class="stat-card-label">Featured</span>
                    <div class="stat-card-icon warning"><i class="fas fa-star"></i></div>
                </div>
                <div class="stat-card-value">{{ services|selectattr('is_featured')|list|length }}</div>
                <div class="stat-card-change neutral"><i class="fas fa-sparkles"></i> Highlighted services</div>
            </div>

            <div class="stat-card" style="--card-accent: #ef4444;">
                <div class="stat-card-header">
                    <span class="stat-card-label">Inactive</span>
                    <div class="stat-card-icon danger"><i class="fas fa-toggle-off"></i></div>
                </div>
                <div class="stat-card-value">{{ services|rejectattr('is_active')|list|length }}</div>
                <div class="stat-card-change down"><i class="fas fa-pause-circle"></i> Disabled services</div>
            </div>
        </div>

        <!-- ===== SERVICES BY CATEGORY ===== -->
        {% for category, cat_services in categorized.items() %}
        <div class="admin-card mb-3">
            <div class="card-header">
                <div class="card-header-left">
                    <div class="card-header-icon" style="background: var(--admin-accent-muted); color: var(--admin-accent);">
                        <i class="fas fa-folder"></i>
                    </div>
                    <div>
                        <h3 style="text-transform: capitalize;">{{ category.replace('_', ' ') }}</h3>
                        <span style="font-size: 11px; color: var(--admin-text-muted);">{{ cat_services|length }} services</span>
                    </div>
                </div>
                <div class="card-actions">
                    <span class="status-badge info" style="font-size: 10px;">{{ cat_services|length }}</span>
                </div>
            </div>
            <div class="card-body no-pad">
                <div class="admin-table-wrapper">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Service</th>
                                <th>Code</th>
                                <th>Price</th>
                                <th>Discount</th>
                                <th>Status</th>
                                <th>Featured</th>
                                <th class="text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for service in cat_services %}
                            <tr>
                                <td>
                                    <div class="table-user">
                                        <div class="table-user-avatar" style="background: var(--admin-accent-muted); color: var(--admin-accent); border-radius: var(--admin-radius-sm);">
                                            <i class="fas fa-cube" style="font-size: 12px;"></i>
                                        </div>
                                        <div class="table-user-info">
                                            <h5>{{ service.service_name }}</h5>
                                            <span>{{ service.short_description[:50] if service.short_description else '' }}{{ '...' if service.short_description and service.short_description|length > 50 else '' }}</span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span style="font-family: monospace; font-size: 12px; color: var(--admin-text-tertiary); background: var(--admin-bg-tertiary); padding: 2px 8px; border-radius: 4px;">
                                        {{ service.service_code }}
                                    </span>
                                </td>
                                <td>
                                    <span style="font-weight: 700; color: var(--admin-text-primary);">₹{{ "{:,}".format(service.base_price) }}</span>
                                </td>
                                <td>
                                    {% if service.discount_percentage > 0 %}
                                    <span class="status-badge success" style="font-size: 10px;">
                                        {{ service.discount_percentage }}% OFF
                                    </span>
                                    {% else %}
                                    <span style="color: var(--admin-text-muted);">—</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button onclick="toggleService('{{ service.id }}')" style="cursor: pointer; background: none; border: none; padding: 0;">
                                        {% if service.is_active %}
                                        <span class="status-badge active">
                                            <span class="status-dot"></span> Active
                                        </span>
                                        {% else %}
                                        <span class="status-badge danger">
                                            <span class="status-dot"></span> Inactive
                                        </span>
                                        {% endif %}
                                    </button>
                                </td>
                                <td>
                                    {% if service.is_featured %}
                                    <span style="color: var(--admin-warning); font-size: 16px;">★</span>
                                    {% else %}
                                    <span style="color: var(--admin-text-muted); font-size: 16px;">☆</span>
                                    {% endif %}
                                </td>
                                <td class="text-right">
                                    <div class="d-flex gap-sm" style="justify-content: flex-end;">
                                        <a href="{{ url_for('admin_enhanced.edit_service', service_id=service.id) }}" class="btn-admin secondary sm" title="Edit">
                                            <i class="fas fa-pen"></i>
                                        </a>
                                        <a href="{{ url_for('services.service_detail', service_code=service.service_code) }}" target="_blank" class="btn-admin ghost sm" title="View">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endfor %}

        {% if not categorized %}
        <div class="admin-card">
            <div class="empty-state" style="padding: 64px;">
                <i class="fas fa-concierge-bell"></i>
                <h4>No Services Yet</h4>
                <p>Start by adding your first service to the catalog</p>
                <a href="{{ url_for('admin_enhanced.create_service') }}" class="btn-admin primary mt-2">
                    <i class="fas fa-plus"></i> Add First Service
                </a>
            </div>
        </div>
        {% endif %}

    </main>
</div>

<script>
(function() {
    'use strict';

    // ===== SIDEBAR =====
    const layout = document.getElementById('adminLayout');
    const toggle = document.getElementById('sidebarToggle');
    if (localStorage.getItem('admin_sidebar_collapsed') === 'true') layout?.classList.add('sidebar-collapsed');
    toggle?.addEventListener('click', () => {
        const collapsed = layout.classList.toggle('sidebar-collapsed');
        localStorage.setItem('admin_sidebar_collapsed', collapsed);
    });
    document.getElementById('mobileSidebarToggle')?.addEventListener('click', () => {
        document.querySelector('.admin-sidebar')?.classList.toggle('mobile-open');
    });

    // ===== TOGGLE SERVICE =====
    window.toggleService = function(serviceId) {
        if (!confirm('Toggle this service\'s active status?')) return;

        fetch(`/admin/services/${serviceId}/toggle`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                showToast('Service status updated', 'success');
                setTimeout(() => location.reload(), 800);
            } else {
                showToast('Error: ' + (data.error || 'Unknown'), 'error');
            }
        })
        .catch(() => showToast('Network error', 'error'));
    };

    // ===== TOAST =====
    function showToast(message, type = 'info', duration = 4000) {
        let container = document.getElementById('admin-toast-container');
        if (!container) {
            container = document.createElement('div');
            container.id = 'admin-toast-container';
            container.className = 'admin-toast-container';
            document.body.appendChild(container);
        }
        const icons = { success: 'fa-check-circle', error: 'fa-exclamation-circle', warning: 'fa-exclamation-triangle', info: 'fa-info-circle' };
        const toast = document.createElement('div');
        toast.className = `admin-toast ${type}`;
        toast.style.setProperty('--toast-duration', `${duration}ms`);
        toast.innerHTML = `<i class="fas ${icons[type] || icons.info}"></i><span>${message}</span><button class="toast-close" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>`;
        container.appendChild(toast);
        setTimeout(() => { toast.style.animation = 'toastOut 0.3s ease forwards'; setTimeout(() => toast.remove(), 300); }, duration);
    }
})();
</script>

</body>
</html>
