<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finucity | Secure Sign In</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* ————————————————————— */
/* ROOT THEME */
/* ————————————————————— */
:root {
--primary:#FBA002;
--primary-dark:#e69200;
--dark:#0a0d0a;
--card:#131814;
--text:#ffffff;
--muted:#9ca89c;
--soft:#6b7a6b;
--border:rgba(255,255,255,0.12);
--radius:18px;
--transition:all .3s cubic-bezier(.4,0,.2,1);
}

/* ————————————————————— */
/* BASE */
/* ————————————————————— */
*{margin:0;padding:0;box-sizing:border-box}
body{
font-family:'Inter',sans-serif;
background:linear-gradient(135deg,#0a0d0a,#131814,#0a0d0a);
min-height:100vh;
display:flex;
align-items:center;
justify-content:center;
padding:22px;
color:#fff
}

.container{
width:100%;
max-width:440px;
background:var(--card);
border-radius:var(--radius);
border:1px solid var(--border);
box-shadow:0 25px 60px rgba(0,0,0,.6);
overflow:hidden;
animation:show .6s ease forwards
}

@keyframes show{
from{opacity:0;transform:translateY(40px)}
to{opacity:1;transform:translateY(0)}
}

/* HEADER */
.header{
padding:40px;
text-align:center;
border-bottom:1px solid var(--border);
position:relative
}

.header::before{
content:'';
position:absolute;
top:0;left:0;
width:100%;height:4px;
background:linear-gradient(90deg,var(--primary),var(--primary-dark))
}

.logo{
display:inline-flex;
gap:14px;
align-items:center;
margin-bottom:24px;
text-decoration:none;
color:white
}

.logo-box{
height:52px;width:52px;
border-radius:14px;
display:flex;
align-items:center;
justify-content:center;
background:linear-gradient(135deg,var(--primary),var(--primary-dark));
box-shadow:0 10px 28px rgba(251,160,2,.35)
}

.logo-box i{font-size:23px;color:#000}

.logo-text h1{font-size:23px;font-weight:800}
.logo-text span{color:var(--muted);font-size:12px}

.header h2{font-size:28px;font-weight:800;margin-bottom:6px}
.header p{color:var(--muted);font-size:14px}

/* FORM SECTION */
.section{padding:34px 40px 40px}

/* MESSAGE */
.message{
padding:16px;border-radius:12px;
margin-bottom:22px;font-size:14px;
display:none;align-items:center;gap:10px
}
.message.error{display:flex;background:rgba(239,68,68,.12);border-left:4px solid #ef4444;color:#f87171}
.message.success{display:flex;background:rgba(34,197,94,.15);border-left:4px solid #22c55e;color:#4ade80}

/* TOGGLE */
.toggle-box{display:flex;background:rgba(0,0,0,.4);border-radius:12px;padding:6px;margin-bottom:18px}
.toggle-btn{
flex:1;padding:12px;border-radius:8px;border:none;
background:transparent;color:var(--muted);font-size:14px;font-weight:600;
cursor:pointer;transition:var(--transition)
}
.toggle-btn.active{background:rgba(251,160,2,.2);color:white}

/* ROLE */
.role-box{
display:grid;grid-template-columns:1fr 1fr;
gap:14px;margin-bottom:26px
}

.role{
padding:16px;
border-radius:14px;
border:1px solid rgba(255,255,255,.12);
background:rgba(255,255,255,.02);
text-align:center;cursor:pointer;
transition:var(--transition);color:var(--muted)
}
.role.active{border-color:var(--primary);color:var(--primary);background:rgba(251,160,2,.14)}
.role i{font-size:22px;margin-bottom:6px;display:block}

/* GOOGLE */
.google{
width:100%;
padding:16px;
border-radius:14px;
border:1px solid rgba(255,255,255,.1);
background:rgba(255,255,255,.04);
font-size:14px;font-weight:700;
cursor:pointer;color:white;
display:flex;align-items:center;justify-content:center;gap:10px;
transition:var(--transition)
}
.google:hover{background:rgba(255,255,255,.15)}

/* DIVIDER */
.divider{
margin:26px 0;
display:flex;align-items:center;gap:16px;
color:#777;font-size:12px;text-transform:uppercase;letter-spacing:1px
}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent)}

/* INPUTS */
.group{margin-bottom:18px}
.group label{display:block;font-size:13px;margin-bottom:8px;color:var(--muted)}
.input-wrap{position:relative}
.input-wrap i{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:#707972}
.input{
width:100%;padding:14px 16px 14px 44px;
border-radius:14px;border:1px solid rgba(255,255,255,.12);
background:rgba(0,0,0,.35);
color:white;font-size:14px
}
.input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(251,160,2,.2)}

/* BUTTON */
.submit{
width:100%;padding:16px;border:none;border-radius:14px;
background:linear-gradient(135deg,#fba002,#e69200);
font-weight:900;font-size:14px;color:black;
cursor:pointer;transition:var(--transition)
}
.submit:hover{transform:translateY(-2px);box-shadow:0 10px 32px rgba(251,160,2,.4)}
.submit:disabled{opacity:.6;cursor:not-allowed}

/* CA NOTICE */
.notice{
background:rgba(251,191,36,.12);
border:1px solid rgba(251,191,36,.3);
padding:12px;border-radius:10px;
color:#fbbf24;
margin-bottom:18px;
display:none
}
.notice.visible{display:block}

/* FOOTER */
.footer{text-align:center;margin-top:26px}
.footer p{color:var(--muted);margin-bottom:10px}
.footer a{color:var(--primary);font-weight:700;text-decoration:none}
.footer a:hover{text-decoration:underline}

.back{
margin-top:10px;display:inline-flex;gap:6px;
color:#777;text-decoration:none
}
.back:hover{color:white}

/* RESPONSIVE */
@media(max-width:480px){
.container{max-width:100%;border-radius:12px}
.section{padding:20px}
.header{padding:30px}
}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<div class="container">
<div class="header">
<a href="/" class="logo">
<div class="logo-box"><i class="fas fa-calculator"></i></div>
<div class="logo-text">
<h1>Finucity</h1>
<span>AI Chartered Accountant</span>
</div>
</a>

<h2 id="title">Sign In</h2>
<p id="subtitle">Continue with Google or email</p>
</div>

<div class="section">

<div id="msg" class="message"></div>

<div id="notice" class="notice">
<i class="fas fa-info-circle"></i> New CA registrations require verification before activation.
</div>

<div class="toggle-box">
<button id="loginBtn" class="toggle-btn active" onclick="setMode('login')">Login</button>
<button id="signupBtn" class="toggle-btn" onclick="setMode('signup')">Sign Up</button>
</div>

<div class="role-box">
<div id="userRole" class="role active" onclick="setRole('user')">
<i class="fas fa-user"></i>User
</div>
<div id="caRole" class="role" onclick="setRole('ca')">
<i class="fas fa-user-tie"></i>Chartered Accountant
</div>
</div>

<button class="google" onclick="googleLogin()">
<i class="fab fa-google"></i> Continue with Google
</button>

<div class="divider">or</div>

<form onsubmit="submitForm(event)">
<div class="group">
<label>Email</label>
<div class="input-wrap">
<i class="fas fa-envelope"></i>
<input id="email" class="input" type="email" placeholder="you@example.com" required>
</div>
</div>

<div class="group">
<label>Password</label>
<div class="input-wrap">
<i class="fas fa-lock"></i>
<input id="password" class="input" type="password" minlength="8" placeholder="********" required>
</div>
</div>

<button id="submit" class="submit">Sign in</button>
</form>

<div class="footer">
<p id="toggleText">Don't have an account?
<a href="#" onclick="toggleSwap()">Sign up</a></p>

<a href="/" class="back"><i class="fas fa-arrow-left"></i>Back to Home</a>
</div>

</div>
</div>

<script>

const SUPABASE_URL = "{{ SUPABASE_URL }}";
const SUPABASE_ANON_KEY = "{{ SUPABASE_ANON_KEY }}";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let mode="login";
let role="user";

document.addEventListener("DOMContentLoaded",()=>updateUI());

// UI update
function setMode(m){mode=m;updateUI()}
function setRole(r){role=r;updateUI()}
function toggleSwap(){mode=mode==="login"?"signup":"login";updateUI()}

function updateUI(){
document.getElementById("loginBtn").classList.toggle("active",mode==="login");
document.getElementById("signupBtn").classList.toggle("active",mode==="signup");

document.getElementById("userRole").classList.toggle("active",role==="user");
document.getElementById("caRole").classList.toggle("active",role==="ca");

document.getElementById("title").textContent=mode==="login"?"Sign In":"Create Account";
document.getElementById("subtitle").textContent=mode==="login"?"Continue with Google or email":"Create your Finucity account";

document.getElementById("submit").textContent=mode==="login"?"Sign In":"Create Account";

document.getElementById("toggleText").innerHTML=
mode==="login"?
`Don't have an account? <a onclick="toggleSwap()">Sign up</a>`:
`Already have account? <a onclick="toggleSwap()">Sign in</a>`;

document.getElementById("notice").classList.toggle("visible",mode==="signup"&&role==="ca");
}

// Messages
function msg(text,type){
const m=document.getElementById("msg");
m.style.display="flex";
m.className="message "+type;
m.innerHTML=`<i class="fas fa-${type==="success"?"check-circle":"exclamation-circle"}"></i>${text}`;
}

// Google login
async function googleLogin(){
msg("", ""); 
const { error }=await supabaseClient.auth.signInWithOAuth({
provider:'google',
options:{redirectTo:window.location.origin+'/auth/callback'}
});
if(error)msg(error.message,"error");
}

// Submit
async function submitForm(e){
e.preventDefault();
let email=document.getElementById("email").value.trim();
let password=document.getElementById("password").value;
let btn=document.getElementById("submit");

btn.disabled=true;

// LOGIN
if(mode==="login"){
const { data,error } = await supabaseClient.auth.signInWithPassword({email,password});
if(error){msg(error.message,"error");btn.disabled=false;return;}
bridge(data.session);return;
}

// SIGNUP
if(role==="ca"){
window.location.href="/auth/ca-apply";
return;
}

const { data,error } = await supabaseClient.auth.signUp({
email,password,options:{data:{role:role}}
});

if(error){msg(error.message,"error");btn.disabled=false;return;}

if(data.session) bridge(data.session);
else msg("Check your email to confirm account","success");
btn.disabled=false;
}

// Bridge
async function bridge(session){
if(!session){
const { data }=await supabaseClient.auth.getSession();
session=data.session;
}
if(!session)return msg("No session","error");

let res=await fetch("/auth/supabase-login",{
method:"POST",
headers:{Authorization:"Bearer "+session.access_token}
});

let data=await res.json();
if(!res.ok)return msg(data.error||"Login failed","error");

if(data.role==="ca"||data.role==="admin")window.location.href="/ca/dashboard";
else if(data.role==="ca_pending")window.location.href="/auth/ca-pending";
else window.location.href="/";
}
</script>

</body>
</html>
