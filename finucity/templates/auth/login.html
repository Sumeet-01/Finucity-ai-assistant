<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finucity | Secure Sign In</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
--primary:#FBA002;
--primary-dark:#e69200;
--dark:#0a0d0a;
--card:#131814;
--text:#ffffff;
--muted:#9ca89c;
--soft:#6b7a6b;
--border: rgba(255,255,255,0.12);
--radius:18px;
--transition:all .3s cubic-bezier(.4,0,.2,1);
}

*{margin:0;padding:0;box-sizing:border-box}
body{
font-family:'Inter',sans-serif;
background:linear-gradient(135deg,#0a0d0a,#131814,#0a0d0a);
min-height:100vh;
display:flex;
align-items:center;
justify-content:center;
padding:22px;
color:#fff
}

.container{
width:100%;
max-width:440px;
background:var(--card);
border-radius:var(--radius);
border:1px solid var(--border);
box-shadow:0 25px 60px rgba(0,0,0,.6);
overflow:hidden;
animation:show .6s ease forwards
}

@keyframes show{
from{opacity:0;transform:translateY(40px)}
to{opacity:1;transform:translateY(0)}
}

.header{
padding:40px;
text-align:center;
border-bottom:1px solid var(--border);
position:relative
}

.header::before{
content:'';
position:absolute;
top:0;left:0;
width:100%;height:4px;
background:linear-gradient(90deg,var(--primary),var(--primary-dark))
}

.logo{
display:inline-flex;
gap:14px;
align-items:center;
margin-bottom:24px;
text-decoration:none;
color:white
}

.logo-box{
height:52px;width:52px;
border-radius:14px;
display:flex;
align-items:center;
justify-content:center;
background:linear-gradient(135deg,var(--primary),var(--primary-dark));
box-shadow:0 10px 28px rgba(251,160,2,.35)
}

.logo-box i{font-size:23px;color:#000}

.logo-text h1{font-size:23px;font-weight:800}
.logo-text span{color:var(--muted);font-size:12px}

.header h2{font-size:28px;font-weight:800;margin-bottom:6px}
.header p{color:var(--muted);font-size:14px}

.section{padding:34px 40px 40px}

.message{
padding:16px;border-radius:12px;
margin-bottom:22px;font-size:14px;
display:none;align-items:center;gap:10px
}
.message.error{display:flex;background:rgba(239,68,68,.12);border-left:4px solid #ef4444;color:#f87171}
.message.success{display:flex;background:rgba(34,197,94,.15);border-left:4px solid #22c55e;color:#4ade80}

.toggle-box{display:flex;background:rgba(0,0,0,.4);border-radius:12px;padding:6px;margin-bottom:18px}
.toggle-btn{
flex:1;padding:12px;border-radius:8px;border:none;
background:transparent;color:var(--muted);font-size:14px;font-weight:600;
cursor:pointer;transition:var(--transition)
}
.toggle-btn.active{background:rgba(251,160,2,.2);color:white}

.role-box{
display:grid;grid-template-columns:1fr 1fr;
gap:14px;margin-bottom:26px
}

.role{
padding:16px;
border-radius:14px;
border:1px solid rgba(255,255,255,.12);
background:rgba(255,255,255,.02);
text-align:center;cursor:pointer;
transition:var(--transition);color:var(--muted)
}
.role.active{border-color:var(--primary);color:var(--primary);background:rgba(251,160,2,.14)}
.role i{font-size:22px;margin-bottom:6px;display:block}

.google{
width:100%;
padding:16px;
border-radius:14px;
border:1px solid rgba(255,255,255,.1);
background:rgba(255,255,255,.04);
font-size:14px;font-weight:700;
cursor:pointer;color:white;
display:flex;align-items:center;justify-content:center;gap:10px;
transition:var(--transition)
}
.google:hover{background:rgba(255,255,255,.15)}

.divider{
margin:26px 0;
display:flex;align-items:center;gap:16px;
color:#777;font-size:12px;text-transform:uppercase;letter-spacing:1px
}
.divider::before,.divider::after{content:'';flex:1;height:1px;background:linear-gradient(90deg,transparent,var(--border),transparent)}

.group{margin-bottom:18px}
.group label{display:block;font-size:13px;margin-bottom:8px;color:var(--muted)}
.input-wrap{position:relative}
.input-wrap i{position:absolute;left:16px;top:50%;transform:translateY(-50%);color:#707972}

.input{
width:100%;padding:14px 16px 14px 44px;
border-radius:14px;border:1px solid rgba(255,255,255,.12);
background:rgba(0,0,0,.35);
color:white;font-size:14px
}
.input:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(251,160,2,.2)}

.submit{
width:100%;padding:16px;border:none;border-radius:14px;
background:linear-gradient(135deg,#fba002,#e69200);
font-weight:900;font-size:14px;color:black;
cursor:pointer;transition:var(--transition)
}
.submit:hover{transform:translateY(-2px);box-shadow:0 10px 32px rgba(251,160,2,.4)}
.submit:disabled{opacity:.6;cursor:not-allowed}

.notice{
background:rgba(251,191,36,.12);
border:1px solid rgba(251,191,36,.3);
padding:12px;border-radius:10px;
color:#fbbf24;
margin-bottom:18px;
display:none
}
.notice.visible{display:block}

.footer{text-align:center;margin-top:26px}
.footer p{color:var(--muted);margin-bottom:10px}
.footer a{color:var(--primary);font-weight:700;text-decoration:none}
.footer a:hover{text-decoration:underline}

.back{
margin-top:10px;display:inline-flex;gap:6px;
color:#777;text-decoration:none
}
.back:hover{color:white}
</style>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<div class="container">
<div class="header">
<a href="/" class="logo">
<div class="logo-box"><i class="fas fa-calculator"></i></div>
<div class="logo-text">
<h1>Finucity</h1>
<span>AI Chartered Accountant</span>
</div>
</a>

<h2 id="title">Sign In</h2>
<p id="subtitle">Continue with Google or email</p>
</div>

<div class="section">

<div id="msg" class="message"></div>

<div id="notice" class="notice">
<i class="fas fa-info-circle"></i> New CA registrations require verification before activation.
</div>

<div class="toggle-box">
<button id="loginBtn" class="toggle-btn active" onclick="setMode('login')">Login</button>
<button id="signupBtn" class="toggle-btn" onclick="setMode('signup')">Sign Up</button>
</div>

<div class="role-box">
<div id="userRole" class="role active" onclick="setRole('user')">
<i class="fas fa-user"></i>User
</div>
<div id="caRole" class="role" onclick="setRole('ca')">
<i class="fas fa-user-tie"></i>Chartered Accountant
</div>
</div>

<button class="google" onclick="googleLogin()">
<i class="fab fa-google"></i> Continue with Google
</button>

<div class="divider">or</div>

<form onsubmit="submitForm(event)">
<div class="group">
<label>Email</label>
<div class="input-wrap">
<i class="fas fa-envelope"></i>
<input id="email" class="input" type="email" placeholder="you@example.com" required>
</div>
</div>

<div class="group">
<label>Password</label>
<div class="input-wrap">
<i class="fas fa-lock"></i>
<input id="password" class="input" type="password" minlength="8" placeholder="********" required>
</div>
</div>

<button id="submit" class="submit" type="submit">Sign in</button>
</form>

<div class="footer">
<p id="toggleText">Don't have an account?
<a onclick="toggleSwap()">Sign up</a></p>

<a href="/" class="back"><i class="fas fa-arrow-left"></i>Back to Home</a>
</div>

</div>
</div>


<script>
// ==================== CONFIG ====================
var SUPABASE_URL = "{{ SUPABASE_URL | default('', true) }}";
var SUPABASE_ANON_KEY = "{{ SUPABASE_ANON_KEY | default('', true) }}";

var supabaseClient = null;
var supabaseAvailable = false;

function isValidCredential(val) {
if (!val || val === '') return false;
if (val.indexOf('{') !== -1 || val.indexOf('}') !== -1) return false;
return true;
}

if (isValidCredential(SUPABASE_URL) && isValidCredential(SUPABASE_ANON_KEY)) {
try {
supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
supabaseAvailable = true;
} catch(e){console.warn("Supabase init failed");}
}

let mode="login";
let role="user";

document.addEventListener("DOMContentLoaded",()=>updateUI());

// UI update
function setMode(m){mode=m;updateUI();clearMsg()}
function setRole(r){role=r;updateUI();clearMsg()}
function toggleSwap(){mode=mode==="login"?"signup":"login";updateUI();clearMsg()}

function updateUI(){
document.getElementById("loginBtn").classList.toggle("active",mode==="login");
document.getElementById("signupBtn").classList.toggle("active",mode==="signup");

document.getElementById("userRole").classList.toggle("active",role==="user");
document.getElementById("caRole").classList.toggle("active",role==="ca");

document.getElementById("title").textContent=mode==="login"?"Sign In":"Create Account";
document.getElementById("subtitle").textContent=mode==="login"?"Continue with Google or email":"Create your Finucity account";

document.getElementById("submit").textContent=mode==="login"?"Sign In":"Create Account";

document.getElementById("toggleText").innerHTML=
mode==="login"?
`Don't have an account? <a onclick="toggleSwap()">Sign up</a>`:
`Already have account? <a onclick="toggleSwap()">Sign in</a>`;

document.getElementById("notice").classList.toggle("visible",mode==="signup"&&role==="ca");
}

function showMsg(text,type){
const m=document.getElementById("msg");
m.style.display="flex";
m.className="message "+type;
m.innerHTML=`<i class="fas fa-${type==="success"?"check-circle":"exclamation-circle"}"></i>${text}`;
}

function clearMsg(){
const m=document.getElementById("msg");
m.style.display="none";
m.className="message";
}

// Google login
function googleLogin(){
clearMsg();
if(!supabaseAvailable){
showMsg("Google login not configured","error");
return;
}

supabaseClient.auth.signInWithOAuth({
provider:'google',
options:{redirectTo:window.location.origin+'/auth/callback?role='+role}
}).then(res=>{
if(res.error)showMsg(res.error.message,"error");
}).catch(()=>showMsg("Failed to connect to Google","error"));
}

// Submit
function submitForm(e){
e.preventDefault();
clearMsg();

let email=document.getElementById("email").value.trim();
let password=document.getElementById("password").value;
let btn=document.getElementById("submit");
let old=btn.textContent;

if(!email)return showMsg("Please enter email","error");
if(password.length<8)return showMsg("Password must be 8+ chars","error");

btn.disabled=true;
btn.textContent=mode==="login"?"Signing in...":"Creating account...";

if(mode==="login"){
if(supabaseAvailable){
supabaseClient.auth.signInWithPassword({email,password})
.then(result=>{
if(result.error)return flaskLogin(email,password,btn,old);
else if(result.data?.session)return bridgeSession(result.data.session,btn,old);
})
.catch(()=>flaskLogin(email,password,btn,old));
} else flaskLogin(email,password,btn,old);
}
else{
if(role==="ca"){window.location.href="/auth/ca-apply";return;}

if(supabaseAvailable){
supabaseClient.auth.signUp({email,password,options:{data:{role}}})
.then(result=>{
if(result.error)return flaskSignup(email,password,btn,old);
else if(result.data?.session)return bridgeSession(result.data.session,btn,old);
else{
showMsg("Check email to confirm","success");
btn.disabled=false;btn.textContent=old;
}
})
.catch(()=>flaskSignup(email,password,btn,old));
} else flaskSignup(email,password,btn,old);
}
}

// Flask login
function flaskLogin(email,password,btn,old){
fetch("/auth/flask-login",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({email,password,role})
})
.then(r=>r.json().then(d=>({ok:r.ok,data:d})))
.then(res=>{
if(!res.ok||!res.data.success)throw new Error(res.data.error||"Invalid credentials");
showMsg("Login successful! Redirecting...","success");
redirectUser(res.data.role,res.data.redirect_url);
})
.catch(e=>{
showMsg(e.message,"error");
btn.disabled=false;
btn.textContent=old;
});
}

// Flask signup
function flaskSignup(email,password,btn,old){
fetch("/auth/flask-signup",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({email,password,first_name:"",last_name:"",role})
})
.then(r=>r.json().then(d=>({ok:r.ok,data:d})))
.then(res=>{
if(!res.ok||!res.data.success)throw new Error(res.data.error||"Signup failed");
showMsg("Account created! Redirecting...","success");
redirectUser(res.data.role,res.data.redirect_url);
})
.catch(e=>{
showMsg(e.message,"error");
btn.disabled=false;
btn.textContent=old;
});
}

// Bridge
function bridgeSession(session,btn,old){
fetch("/auth/supabase-login",{
method:"POST",
headers:{
"Authorization":"Bearer "+session.access_token,
"Content-Type":"application/json"
},
body:JSON.stringify({role})
})
.then(r=>r.json().then(d=>({ok:r.ok,data:d})))
.then(res=>{
if(!res.ok)throw new Error(res.data.error||"Login failed");
showMsg("Login successful! Redirecting...","success");
redirectUser(res.data.role,res.data.redirect_url);
})
.catch(e=>{
showMsg(e.message,"error");
btn.disabled=false;
btn.textContent=old;
});
}

// Redirect
function redirectUser(role,url){
setTimeout(()=>{
if(url)window.location.href=url;
else if(role==="ca"||role==="admin")window.location.href="/ca/dashboard";
else if(role==="ca_pending")window.location.href="/auth/ca-pending";
else window.location.href="/user/dashboard";
},800);
}
</script>

</body>
</html>
