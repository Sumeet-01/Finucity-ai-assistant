{% extends "ca/layout.html" %}

{% block page_title %}Messages - CA Workspace{% endblock %}
{% block page_header %}Messages{% endblock %}
{% block page_subtitle %}Chat with your clients in real-time{% endblock %}

{% block extra_page_css %}
<style>
    .messages-container {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: var(--space-3);
        height: calc(100vh - var(--topbar-height) - 120px);
    }
    
    /* Conversations List */
    .conversations-sidebar {
        background: rgba(255,255,255,0.03);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: var(--border-radius-lg);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .conversations-header {
        padding: var(--space-3);
        border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    
    .conversations-search {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        padding: 10px 12px;
        background: rgba(255,255,255,0.05);
        border-radius: var(--border-radius-md);
    }
    
    .conversations-search input {
        flex: 1;
        background: none;
        border: none;
        outline: none;
        color: var(--text-primary);
        font-size: var(--font-size-sm);
    }
    
    .conversations-list {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-2);
    }
    
    .conversation-item {
        padding: var(--space-3);
        border-radius: var(--border-radius-md);
        cursor: pointer;
        transition: background var(--transition-fast);
        margin-bottom: var(--space-1);
        border: 1px solid transparent;
    }
    
    .conversation-item:hover {
        background: rgba(255,255,255,0.05);
    }
    
    .conversation-item.active {
        background: rgba(212, 175, 55, 0.1);
        border-color: rgba(212, 175, 55, 0.3);
    }
    
    .conversation-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 4px;
    }
    
    .conversation-name {
        font-size: var(--font-size-sm);
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .conversation-time {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
    }
    
    .conversation-preview {
        font-size: var(--font-size-sm);
        color: var(--text-tertiary);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    /* Chat Area */
    .chat-area {
        background: rgba(255,255,255,0.03);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: var(--border-radius-lg);
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }
    
    .chat-header {
        padding: var(--space-3);
        border-bottom: 1px solid rgba(255,255,255,0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .chat-user-info {
        display: flex;
        align-items: center;
        gap: var(--space-2);
    }
    
    .chat-user-avatar {
        width: 40px;
        height: 40px;
        border-radius: var(--border-radius-md);
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.05));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        font-weight: 700;
        color: var(--accent-gold);
    }
    
    .chat-user-details h3 {
        font-size: var(--font-size-base);
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .chat-user-details p {
        font-size: var(--font-size-sm);
        color: var(--text-tertiary);
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: var(--space-4);
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
    }
    
    .message {
        display: flex;
        gap: var(--space-2);
        max-width: 70%;
    }
    
    .message.sent {
        align-self: flex-end;
        flex-direction: row-reverse;
    }
    
    .message-avatar {
        width: 32px;
        height: 32px;
        border-radius: var(--border-radius-sm);
        background: linear-gradient(135deg, rgba(212, 175, 55, 0.2), rgba(212, 175, 55, 0.05));
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: 700;
        color: var(--accent-gold);
        flex-shrink: 0;
    }
    
    .message-content {
        flex: 1;
    }
    
    .message-bubble {
        padding: var(--space-2) var(--space-3);
        border-radius: var(--border-radius-md);
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.08);
        color: var(--text-primary);
        font-size: var(--font-size-sm);
        line-height: 1.5;
        word-wrap: break-word;
    }
    
    .message.sent .message-bubble {
        background: rgba(212, 175, 55, 0.15);
        border-color: rgba(212, 175, 55, 0.3);
    }
    
    .message-time {
        font-size: var(--font-size-xs);
        color: var(--text-muted);
        margin-top: 4px;
    }
    
    .chat-input-area {
        padding: var(--space-3);
        border-top: 1px solid rgba(255,255,255,0.08);
    }
    
    .chat-input-wrapper {
        display: flex;
        gap: var(--space-2);
        align-items: flex-end;
    }
    
    .chat-input {
        flex: 1;
        padding: 12px 16px;
        background: rgba(255,255,255,0.05);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: var(--border-radius-md);
        color: var(--text-primary);
        font-size: var(--font-size-sm);
        resize: vertical;
        min-height: 44px;
        max-height: 120px;
        font-family: inherit;
    }
    
    .chat-input:focus {
        outline: none;
        border-color: var(--accent-gold);
    }
    
    .chat-send-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, var(--accent-gold), #d4af37);
        color: #000;
        border: none;
        border-radius: var(--border-radius-md);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-fast);
    }
    
    .chat-send-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(212, 175, 55, 0.3);
    }
    
    .chat-empty {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: var(--text-tertiary);
        padding: var(--space-6);
    }
    
    .chat-empty i {
        font-size: 64px;
        margin-bottom: var(--space-3);
        opacity: 0.3;
    }
</style>
{% endblock %}

{% block page_content %}
<div class="messages-container">
    <!-- Conversations Sidebar -->
    <div class="conversations-sidebar">
        <div class="conversations-header">
            <div class="conversations-search">
                <i class="fas fa-search"></i>
                <input type="text" id="searchConversations" placeholder="Search...">
            </div>
        </div>
        <div class="conversations-list" id="conversationsList">
            <div class="skeleton" style="height: 60px; margin-bottom: 8px;"></div>
            <div class="skeleton" style="height: 60px;"></div>
        </div>
    </div>
    
    <!-- Chat Area -->
    <div class="chat-area">
        <div class="chat-empty" id="chatEmpty">
            <i class="fas fa-comments"></i>
            <h3>Select a conversation</h3>
            <p>Choose a client to start messaging</p>
        </div>
        
        <div id="chatContent" style="display: none; flex: 1; display: flex; flex-direction: column;">
            <div class="chat-header" id="chatHeader"></div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <textarea id="messageInput" class="chat-input" placeholder="Type message..." rows="1"></textarea>
                    <button class="chat-send-btn" id="sendBtn">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let conversations = [];
let activeConsultationId = null;

document.addEventListener('DOMContentLoaded', async () => {
    await loadConversations();
    setupInputHandlers();
    
    const params = new URLSearchParams(window.location.search);
    const consultationId = params.get('consultation');
    if (consultationId) selectConversation(consultationId);
});

async function loadConversations() {
    const supabase = window.supabase;
    const caId = window.CA_ID;
    
    try {
        const { data, error } = await supabase
            .from('consultations')
            .select(`*, users!consultations_client_id_fkey (email, first_name, last_name)`)
            .eq('ca_id', caId)
            .in('status', ['active', 'pending'])
            .order('updated_at', { ascending: false });
        
        if (error) throw error;
        conversations = data || [];
        renderConversations();
    } catch (error) {
        console.error('Error loading conversations:', error);
    }
}

function renderConversations() {
    const list = document.getElementById('conversationsList');
    
    if (conversations.length === 0) {
        list.innerHTML = '<div style="padding: 40px; text-align: center; color: var(--text-tertiary);"><p>No conversations</p></div>';
        return;
    }
    
    list.innerHTML = conversations.map(conv => {
        const client = conv.users;
        const clientName = client?.first_name ? `${client.first_name} ${client.last_name || ''}` : client?.email || 'Unknown';
        const activeClass = conv.id === activeConsultationId ? 'active' : '';
        
        return `
            <div class="conversation-item ${activeClass}" onclick="selectConversation('${conv.id}')">
                <div class="conversation-header">
                    <div class="conversation-name">${clientName}</div>
                    <div class="conversation-time">${getTimeAgo(new Date(conv.updated_at))}</div>
                </div>
                <div class="conversation-preview">${conv.service_type || 'Consultation'}</div>
            </div>
        `;
    }).join('');
}

async function selectConversation(consultationId) {
    activeConsultationId = consultationId;
    renderConversations();
    
    const consultation = conversations.find(c => c.id === consultationId);
    if (!consultation) return;
    
    document.getElementById('chatEmpty').style.display = 'none';
    document.getElementById('chatContent').style.display = 'flex';
    
    const client = consultation.users;
    const clientName = client?.first_name ? `${client.first_name} ${client.last_name || ''}` : 'Unknown';
    const initials = client?.first_name ? `${client.first_name[0]}${client.last_name?.[0] || ''}` : 'U';
    
    document.getElementById('chatHeader').innerHTML = `
        <div class="chat-user-info">
            <div class="chat-user-avatar">${initials}</div>
            <div class="chat-user-details">
                <h3>${clientName}</h3>
                <p>${consultation.service_type || 'Consultation'}</p>
            </div>
        </div>
    `;
    
    await loadMessages(consultationId);
    setupMessageRealtime(consultationId);
}

async function loadMessages(consultationId) {
    const supabase = window.supabase;
    const messagesContainer = document.getElementById('chatMessages');
    
    try {
        const { data, error } = await supabase
            .from('consultation_messages')
            .select('*')
            .eq('consultation_id', consultationId)
            .order('created_at', { ascending: true });
        
        if (error) throw error;
        
        if (!data || data.length === 0) {
            messagesContainer.innerHTML = '<div style="text-align: center; color: var(--text-tertiary); padding: 40px;"><p>No messages yet</p></div>';
            return;
        }
        
        const caId = window.CA_ID;
        messagesContainer.innerHTML = data.map(msg => {
            const isSent = msg.sender_id === caId;
            return `
                <div class="message ${isSent ? 'sent' : 'received'}">
                    <div class="message-avatar">${isSent ? 'CA' : 'U'}</div>
                    <div class="message-content">
                        <div class="message-bubble">${msg.message}</div>
                        <div class="message-time">${formatMessageTime(new Date(msg.created_at))}</div>
                    </div>
                </div>
            `;
        }).join('');
        
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    } catch (error) {
        console.error('Error loading messages:', error);
    }
}

function setupMessageRealtime(consultationId) {
    const supabase = window.supabase;
    
    supabase
        .channel(`messages-${consultationId}`)
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'consultation_messages',
            filter: `consultation_id=eq.${consultationId}`
        }, (payload) => {
            appendMessage(payload.new);
        })
        .subscribe();
}

function appendMessage(message) {
    const messagesContainer = document.getElementById('chatMessages');
    const caId = window.CA_ID;
    const isSent = message.sender_id === caId;
    
    messagesContainer.insertAdjacentHTML('beforeend', `
        <div class="message ${isSent ? 'sent' : 'received'}">
            <div class="message-avatar">${isSent ? 'CA' : 'U'}</div>
            <div class="message-content">
                <div class="message-bubble">${message.message}</div>
                <div class="message-time">${formatMessageTime(new Date(message.created_at))}</div>
            </div>
        </div>
    `);
    
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function setupInputHandlers() {
    const input = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    
    input.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
    
    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    sendBtn.addEventListener('click', sendMessage);
}

async function sendMessage() {
    const input = document.getElementById('messageInput');
    const message = input.value.trim();
    
    if (!message || !activeConsultationId) return;
    
    const supabase = window.supabase;
    const caId = window.CA_ID;
    
    try {
        const { error } = await supabase
            .from('consultation_messages')
            .insert({
                consultation_id: activeConsultationId,
                sender_id: caId,
                recipient_id: conversations.find(c => c.id === activeConsultationId)?.client_id,
                message: message
            });
        
        if (error) throw error;
        
        input.value = '';
        input.style.height = 'auto';
    } catch (error) {
        console.error('Error sending message:', error);
        alert('Failed to send message');
    }
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    return date.toLocaleDateString('en-IN');
}

function formatMessageTime(date) {
    const today = new Date();
    const messageDate = new Date(date);
    
    if (messageDate.toDateString() === today.toDateString()) {
        return messageDate.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
    }
    
    return messageDate.toLocaleDateString('en-IN', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
}
</script>
{% endblock %}
