{% extends "ca/layout.html" %}

{% block page_title %}Earnings - CA Workspace{% endblock %}
{% block page_header %}Earnings{% endblock %}
{% block page_subtitle %}Track your income and financial performance{% endblock %}

{% block extra_page_css %}
<style>
    .earnings-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: var(--space-3); margin-bottom: var(--space-4); }
</style>
{% endblock %}

{% block page_content %}
<div class="earnings-stats">
    <div class="metric-card">
        <div class="metric-header">
            <span class="metric-label">Total Earnings</span>
            <div class="metric-icon">₹</div>
        </div>
        <div class="metric-value" id="totalEarnings">
            <div class="skeleton" style="width: 120px; height: 32px;"></div>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-header">
            <span class="metric-label">This Month</span>
            <div class="metric-icon"><i class="fas fa-calendar-alt"></i></div>
        </div>
        <div class="metric-value" id="monthEarnings">
            <div class="skeleton" style="width: 100px; height: 32px;"></div>
        </div>
    </div>
    <div class="metric-card">
        <div class="metric-header">
            <span class="metric-label">Pending</span>
            <div class="metric-icon"><i class="fas fa-clock"></i></div>
        </div>
        <div class="metric-value" id="pendingEarnings">
            <div class="skeleton" style="width: 80px; height: 32px;"></div>
        </div>
    </div>
</div>

<div class="glass-card">
    <h3 style="margin-bottom: var(--space-3); font-size: var(--font-size-lg); font-weight: 600;">Transaction History</h3>
    <div class="data-table-wrapper" id="earningsTable">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Client</th>
                    <th>Service</th>
                    <th>Amount</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="earningsBody">
                <tr><td colspan="5"><div class="skeleton" style="width: 100%; height: 40px;"></div></td></tr>
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const supabase = window.supabase;
    const caId = window.CA_ID;
    
    try {
        const { data, error } = await supabase
            .from('ca_earnings')
            .select('*')
            .eq('ca_id', caId)
            .order('created_at', { ascending: false });
        
        if (!error && data) {
            const total = data.reduce((sum, e) => sum + (e.amount || 0), 0);
            document.getElementById('totalEarnings').textContent = `₹${total.toLocaleString('en-IN')}`;
            
            const currentMonth = new Date().toISOString().slice(0, 7);
            const monthTotal = data.filter(e => e.created_at?.startsWith(currentMonth)).reduce((sum, e) => sum + (e.amount || 0), 0);
            document.getElementById('monthEarnings').textContent = `₹${monthTotal.toLocaleString('en-IN')}`;
            
            const pending = data.filter(e => e.status === 'pending').reduce((sum, e) => sum + (e.amount || 0), 0);
            document.getElementById('pendingEarnings').textContent = `₹${pending.toLocaleString('en-IN')}`;
            
            const tbody = document.getElementById('earningsBody');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">No transactions yet</td></tr>';
            } else {
                tbody.innerHTML = data.slice(0, 10).map(e => `
                    <tr>
                        <td>${new Date(e.created_at).toLocaleDateString('en-IN')}</td>
                        <td>Client ${e.consultation_id?.slice(0, 8)}</td>
                        <td>${e.service_type || 'Consultation'}</td>
                        <td>₹${(e.amount || 0).toLocaleString('en-IN')}</td>
                        <td><span class="status-badge ${e.status || 'pending'}">${(e.status || 'pending').charAt(0).toUpperCase() + (e.status || 'pending').slice(1)}</span></td>
                    </tr>
                `).join('');
            }
        }
    } catch (error) {
        console.error('Error loading earnings:', error);
    }
});
</script>
{% endblock %}
