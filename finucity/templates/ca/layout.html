{% extends "base.html" %}

{% block title %}{% block page_title %}CA Dashboard{% endblock %} | Finucity{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ca-workspace.css') }}">
{% block extra_page_css %}{% endblock %}
{% endblock %}

{% block content %}
<!-- Admin Status Banners -->
{% if current_user._data.get('ca_status') == 'suspended' %}
<div class="admin-banner suspended">
    <div class="banner-content">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
        </svg>
        <span>Your account has been suspended. Contact support for assistance.</span>
    </div>
</div>
{% elif current_user._data.get('verification_status') and current_user._data.get('verification_status') not in ['verified', 'approved', 'active'] %}
<div class="admin-banner warning">
    <div class="banner-content">
        <svg width="20" height="20" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
        </svg>
        <span>Verification required. Some features are limited until verified.</span>
    </div>
</div>
{% endif %}

<div class="ca-workspace">
    <!-- Sidebar -->
    <aside class="ca-sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">
                <div class="logo-icon">
                    <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div class="logo-text">
                    <span class="logo-title">Finucity</span>
                    <span class="logo-subtitle">CA Workspace</span>
                </div>
            </div>
        </div>

        <nav class="sidebar-nav">
            <div class="nav-section">
                <div class="nav-section-title">Overview</div>
                <a href="{{ url_for('main.ca_dashboard') }}" class="nav-item {% if request.endpoint == 'main.ca_dashboard' %}active{% endif %}">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                    </svg>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('main.ca_insights') }}" class="nav-item {% if request.endpoint == 'main.ca_insights' %}active{% endif %}">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <span>Insights</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Clients</div>
                <a href="{{ url_for('main.ca_clients') }}" class="nav-item {% if request.endpoint == 'main.ca_clients' %}active{% endif %}">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                    <span>All Clients</span>
                </a>
                <a href="{{ url_for('main.ca_messages') }}" class="nav-item {% if request.endpoint == 'main.ca_messages' %}active{% endif %}">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
                    </svg>
                    <span>Messages</span>
                    <span class="nav-badge" id="unreadCount">0</span>
                </a>
                <a href="{{ url_for('main.ca_calendar') }}" class="nav-item {% if request.endpoint == 'main.ca_calendar' %}active{% endif %}">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                    </svg>
                    <span>Calendar</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Business</div>
                <a href="{{ url_for('main.ca_earnings') }}" class="nav-item {% if request.endpoint == 'main.ca_earnings' %}active{% endif %}">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <span>Earnings</span>
                </a>
                <a href="{{ url_for('main.ca_services') }}" class="nav-item {% if request.endpoint == 'main.ca_services' %}active{% endif %}">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/>
                    </svg>
                    <span>Services</span>
                </a>
                <a href="{{ url_for('main.ca_documents') }}" class="nav-item {% if request.endpoint == 'main.ca_documents' %}active{% endif %}">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    <span>Documents</span>
                </a>
                <a href="{{ url_for('main.ca_reviews') }}" class="nav-item {% if request.endpoint == 'main.ca_reviews' %}active{% endif %}">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>
                    </svg>
                    <span>Reviews</span>
                </a>
            </div>

            <div class="nav-section">
                <div class="nav-section-title">Account</div>
                <a href="{{ url_for('main.ca_profile') }}" class="nav-item {% if request.endpoint == 'main.ca_profile' %}active{% endif %}">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                    </svg>
                    <span>Profile</span>
                </a>
                <a href="{{ url_for('main.ca_settings') }}" class="nav-item {% if request.endpoint == 'main.ca_settings' %}active{% endif %}">
                    <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    </svg>
                    <span>Settings</span>
                </a>
            </div>
        </nav>

        <div class="sidebar-footer">
            <div class="user-profile">
                <div class="user-avatar">
                    <span>{{ current_user.first_name[0] if current_user.first_name else 'C' }}{{ current_user.last_name[0] if current_user.last_name else 'A' }}</span>
                </div>
                <div class="user-info">
                    <div class="user-name">{{ current_user.first_name or 'CA' }} {{ current_user.last_name or 'Professional' }}</div>
                    <div class="user-role">Chartered Accountant</div>
                </div>
            </div>
            <a href="{{ url_for('auth.logout') }}" class="logout-btn" title="Logout">
                <svg width="18" height="18" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
            </a>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="ca-main">
        <!-- Top Bar -->
        <header class="ca-topbar">
            <div class="topbar-left">
                <h1 class="page-title">{% block page_header %}Dashboard{% endblock %}</h1>
                <p class="page-subtitle">{% block page_subtitle %}{% endblock %}</p>
            </div>
            <div class="topbar-right">
                <button class="topbar-icon-btn" id="notificationsBtn">
                    <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"/>
                    </svg>
                    <span class="notification-dot"></span>
                </button>
                <div class="topbar-divider"></div>
                <div class="verification-badge {% if current_user.ca_verification_status == 'verified' %}verified{% else %}pending{% endif %}">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                    </svg>
                    <span>{% if current_user.ca_verification_status == 'verified' %}Verified{% else %}Pending{% endif %}</span>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="ca-content">
            {% block page_content %}{% endblock %}
        </div>
    </main>
</div>

<!-- Supabase Configuration -->
<script>
    window.SUPABASE_URL = "{{ SUPABASE_URL }}";
    window.SUPABASE_ANON_KEY = "{{ SUPABASE_ANON_KEY }}";
    window.CA_ID = "{{ current_user.id }}";
    window.CA_STATUS = "{{ current_user._data.get('ca_status', 'active') }}";
    window.CA_VERIFIED = {{ 'true' if current_user._data.get('verification_status') in ['verified', 'approved', 'active'] else 'false' }};
</script>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Initialize Supabase
    const supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY);
    
    // Load unread message count
    async function loadUnreadCount() {
        try {
            const { data, error } = await supabase
                .from('consultation_messages')
                .select('id', { count: 'exact', head: true })
                .eq('recipient_id', window.CA_ID)
                .eq('is_read', false);
            
            if (!error && data) {
                const badge = document.getElementById('unreadCount');
                if (badge && data > 0) {
                    badge.textContent = data;
                    badge.style.display = 'inline-flex';
                }
            }
        } catch (err) {
            console.error('Error loading unread count:', err);
        }
    }
    
    // Subscribe to new messages
    supabase
        .channel('ca-messages')
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'consultation_messages',
            filter: `recipient_id=eq.${window.CA_ID}`
        }, () => {
            loadUnreadCount();
        })
        .subscribe();
    
    // Load on page load
    document.addEventListener('DOMContentLoaded', loadUnreadCount);
</script>

{% block extra_scripts %}{% endblock %}
{% endblock %}
