{% extends "ca/layout.html" %}

{% block page_title %}Dashboard - CA Workspace{% endblock %}
{% block page_header %}Dashboard{% endblock %}
{% block page_subtitle %}Your complete CA workspace overview{% endblock %}

{% block extra_page_css %}
<style>
    /* Page Container */
    .dashboard-container {
        animation: fadeIn 0.5s ease-out;
    }
    
    /* Quick Stats Grid */
    .dashboard-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: var(--space-3);
        margin-bottom: var(--space-4);
    }
    
    .stat-card {
        background: rgba(255,255,255,0.03);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: var(--border-radius-lg);
        padding: var(--space-4);
        position: relative;
        overflow: hidden;
        transition: all var(--transition-base);
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-gold), transparent);
        opacity: 0;
        transition: opacity var(--transition-base);
    }
    
    .stat-card:hover {
        border-color: rgba(255,255,255,0.12);
        transform: translateY(-2px);
    }
    
    .stat-card:hover::before {
        opacity: 1;
    }
    
    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-3);
    }
    
    .stat-info {
        flex: 1;
    }
    
    .stat-icon {
        width: 48px;
        height: 48px;
        border-radius: var(--border-radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        background: rgba(255,255,255,0.05);
        color: var(--accent-gold);
    }
    
    .stat-label {
        font-size: var(--font-size-sm);
        color: var(--text-tertiary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
        margin-bottom: var(--space-1);
    }
    
    .stat-value {
        font-size: var(--font-size-2xl);
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: var(--space-1);
    }
    
    .stat-trend {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        font-size: var(--font-size-sm);
        padding: 4px 8px;
        border-radius: var(--border-radius-sm);
        font-weight: 500;
    }
    
    .stat-trend.positive {
        color: var(--fintech-green);
        background: rgba(16, 185, 129, 0.1);
    }
    
    .stat-trend.negative {
        color: var(--fintech-red);
        background: rgba(239, 68, 68, 0.1);
    }
    
    /* Recent Activity Section */
    .recent-section {
        margin-bottom: var(--space-4);
    }
    
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-3);
    }
    
    .section-title {
        font-size: var(--font-size-lg);
        font-weight: 600;
        color: var(--text-primary);
    }
    
    .section-action {
        color: var(--accent-gold);
        text-decoration: none;
        font-size: var(--font-size-sm);
        font-weight: 500;
        transition: color var(--transition-fast);
    }
    
    .section-action:hover {
        color: var(--text-primary);
    }
    
    /* Activity List */
    .activity-list {
        display: grid;
        gap: var(--space-2);
    }
    
    .activity-item {
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.08);
        border-radius: var(--border-radius-md);
        padding: var(--space-3);
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        transition: all var(--transition-fast);
    }
    
    .activity-item:hover {
        background: rgba(255,255,255,0.05);
        border-color: rgba(255,255,255,0.12);
    }
    
    .activity-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--border-radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
        font-size: 16px;
    }
    
    .activity-icon.new-client {
        background: rgba(16, 185, 129, 0.15);
        color: var(--fintech-green);
    }
    
    .activity-icon.message {
        background: rgba(59, 130, 246, 0.15);
        color: var(--fintech-blue);
    }
    
    .activity-icon.booking {
        background: rgba(212, 175, 55, 0.15);
        color: var(--accent-gold);
    }
    
    .activity-icon.payment {
        background: rgba(16, 185, 129, 0.15);
        color: var(--fintech-green);
    }
    
    .activity-content {
        flex: 1;
    }
    
    .activity-title {
        font-size: var(--font-size-base);
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: 4px;
    }
    
    .activity-description {
        font-size: var(--font-size-sm);
        color: var(--text-tertiary);
    }
    
    .activity-time {
        font-size: var(--font-size-sm);
        color: var(--text-muted);
        white-space: nowrap;
    }
    
    /* Empty State */
    .activity-empty {
        text-align: center;
        padding: var(--space-6);
        color: var(--text-tertiary);
    }
    
    .activity-empty i {
        font-size: 48px;
        margin-bottom: var(--space-3);
        opacity: 0.3;
    }
</style>
{% endblock %}

{% block page_content %}
<div class="dashboard-container">
    <!-- Quick Stats -->
    <div class="dashboard-stats">
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-info">
                    <div class="stat-label">Total Clients</div>
                    <div class="stat-value" id="totalClients">
                        <div class="skeleton" style="width: 80px; height: 32px;"></div>
                    </div>
                    <div class="stat-trend positive" id="clientsTrend" style="visibility: hidden;">
                        <i class="fas fa-arrow-up"></i>
                        <span>12% this month</span>
                    </div>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-info">
                    <div class="stat-label">Active Consultations</div>
                    <div class="stat-value" id="activeConsultations">
                        <div class="skeleton" style="width: 60px; height: 32px;"></div>
                    </div>
                    <div class="stat-trend positive" id="consultationsTrend" style="visibility: hidden;">
                        <i class="fas fa-arrow-up"></i>
                        <span>8 new</span>
                    </div>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-handshake"></i>
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-info">
                    <div class="stat-label">Monthly Earnings</div>
                    <div class="stat-value" id="monthlyEarnings">
                        <div class="skeleton" style="width: 120px; height: 32px;"></div>
                    </div>
                    <div class="stat-trend positive" id="earningsTrend" style="visibility: hidden;">
                        <i class="fas fa-arrow-up"></i>
                        <span>18% growth</span>
                    </div>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-rupee-sign"></i>
                </div>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-info">
                    <div class="stat-label">Avg Response Time</div>
                    <div class="stat-value" id="responseTime">
                        <div class="skeleton" style="width: 90px; height: 32px;"></div>
                    </div>
                    <div class="stat-trend positive" id="responseTrend" style="visibility: hidden;">
                        <i class="fas fa-arrow-down"></i>
                        <span>Improved</span>
                    </div>
                </div>
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="recent-section">
        <div class="section-header">
            <h2 class="section-title">Recent Activity</h2>
            <a href="/ca/clients" class="section-action">View All →</a>
        </div>
        
        <div class="activity-list" id="activityList">
            <!-- Loading state -->
            <div class="activity-item">
                <div class="skeleton" style="width: 40px; height: 40px; border-radius: 8px;"></div>
                <div style="flex: 1;">
                    <div class="skeleton" style="width: 200px; height: 16px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="width: 300px; height: 14px;"></div>
                </div>
                <div class="skeleton" style="width: 80px; height: 14px;"></div>
            </div>
            <div class="activity-item">
                <div class="skeleton" style="width: 40px; height: 40px; border-radius: 8px;"></div>
                <div style="flex: 1;">
                    <div class="skeleton" style="width: 180px; height: 16px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="width: 280px; height: 14px;"></div>
                </div>
                <div class="skeleton" style="width: 80px; height: 14px;"></div>
            </div>
            <div class="activity-item">
                <div class="skeleton" style="width: 40px; height: 40px; border-radius: 8px;"></div>
                <div style="flex: 1;">
                    <div class="skeleton" style="width: 220px; height: 16px; margin-bottom: 8px;"></div>
                    <div class="skeleton" style="width: 320px; height: 14px;"></div>
                </div>
                <div class="skeleton" style="width: 80px; height: 14px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Recent Client Requests -->
    <div class="recent-section">
        <div class="section-header">
            <h2 class="section-title">Recent Client Requests</h2>
            <a href="/ca/clients" class="section-action">View All →</a>
        </div>
        
        <div class="glass-card">
            <div class="data-table-wrapper" id="requestsTableWrapper">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Service</th>
                            <th>Budget</th>
                            <th>Status</th>
                            <th>Time</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requestsTableBody">
                        <!-- Loading skeleton rows -->
                        <tr>
                            <td><div class="skeleton" style="width: 120px; height: 16px;"></div></td>
                            <td><div class="skeleton" style="width: 100px; height: 16px;"></div></td>
                            <td><div class="skeleton" style="width: 80px; height: 16px;"></div></td>
                            <td><div class="skeleton" style="width: 70px; height: 20px;"></div></td>
                            <td><div class="skeleton" style="width: 90px; height: 16px;"></div></td>
                            <td><div class="skeleton" style="width: 60px; height: 28px;"></div></td>
                        </tr>
                        <tr>
                            <td><div class="skeleton" style="width: 120px; height: 16px;"></div></td>
                            <td><div class="skeleton" style="width: 100px; height: 16px;"></div></td>
                            <td><div class="skeleton" style="width: 80px; height: 16px;"></div></td>
                            <td><div class="skeleton" style="width: 70px; height: 20px;"></div></td>
                            <td><div class="skeleton" style="width: 90px; height: 16px;"></div></td>
                            <td><div class="skeleton" style="width: 60px; height: 28px;"></div></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const supabase = window.supabase;
    const caId = window.CA_ID;
    
    if (!supabase || !caId) {
        console.error('Supabase or CA ID not initialized');
        return;
    }
    
    // Load dashboard stats
    await loadDashboardStats();
    
    // Load recent activity
    await loadRecentActivity();
    
    // Load recent requests
    await loadRecentRequests();
    
    // Set up real-time subscriptions
    setupRealtimeSubscriptions();
});

async function loadDashboardStats() {
    const supabase = window.supabase;
    const caId = window.CA_ID;
    
    try {
        // Get total clients count
        const { data: clients, error: clientsError } = await supabase
            .from('consultations')
            .select('client_id', { count: 'exact', head: true })
            .eq('ca_id', caId);
        
        if (!clientsError && clients !== null) {
            document.getElementById('totalClients').innerHTML = clients;
            document.getElementById('clientsTrend').style.visibility = 'visible';
        }
        
        // Get active consultations count
        const { data: activeConsults, error: activeError } = await supabase
            .from('consultations')
            .select('*', { count: 'exact', head: true })
            .eq('ca_id', caId)
            .eq('status', 'active');
        
        if (!activeError && activeConsults !== null) {
            document.getElementById('activeConsultations').innerHTML = activeConsults;
            document.getElementById('consultationsTrend').style.visibility = 'visible';
        }
        
        // Get monthly earnings
        const currentMonth = new Date().toISOString().slice(0, 7);
        const { data: earnings, error: earningsError } = await supabase
            .from('ca_earnings')
            .select('amount')
            .eq('ca_id', caId)
            .gte('created_at', `${currentMonth}-01`);
        
        if (!earningsError && earnings) {
            const totalEarnings = earnings.reduce((sum, e) => sum + (e.amount || 0), 0);
            document.getElementById('monthlyEarnings').innerHTML = `₹${totalEarnings.toLocaleString('en-IN')}`;
            document.getElementById('earningsTrend').style.visibility = 'visible';
        }
        
        // Calculate average response time (mock for now - needs message timestamps)
        document.getElementById('responseTime').innerHTML = '2.5 hrs';
        document.getElementById('responseTrend').style.visibility = 'visible';
        
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

async function loadRecentActivity() {
    const supabase = window.supabase;
    const caId = window.CA_ID;
    const activityList = document.getElementById('activityList');
    
    try {
        // Get recent consultations (last 5)
        const { data: recentConsults, error } = await supabase
            .from('consultations')
            .select(`
                *,
                users!consultations_client_id_fkey (
                    email,
                    first_name,
                    last_name
                )
            `)
            .eq('ca_id', caId)
            .order('created_at', { ascending: false })
            .limit(5);
        
        if (error) throw error;
        
        if (!recentConsults || recentConsults.length === 0) {
            activityList.innerHTML = `
                <div class="activity-empty">
                    <i class="fas fa-inbox"></i>
                    <p>No recent activity yet</p>
                </div>
            `;
            return;
        }
        
        activityList.innerHTML = recentConsults.map(consultation => {
            const clientName = consultation.users?.first_name 
                ? `${consultation.users.first_name} ${consultation.users.last_name || ''}`
                : consultation.users?.email || 'Unknown Client';
            
            const timeAgo = getTimeAgo(new Date(consultation.created_at));
            
            let iconClass = 'new-client';
            let iconName = 'fa-user-plus';
            let activityTitle = 'New Client Request';
            
            if (consultation.status === 'active') {
                iconClass = 'booking';
                iconName = 'fa-calendar-check';
                activityTitle = 'Active Consultation';
            } else if (consultation.status === 'completed') {
                iconClass = 'payment';
                iconName = 'fa-check-circle';
                activityTitle = 'Completed Consultation';
            }
            
            return `
                <div class="activity-item">
                    <div class="activity-icon ${iconClass}">
                        <i class="fas ${iconName}"></i>
                    </div>
                    <div class="activity-content">
                        <div class="activity-title">${activityTitle}</div>
                        <div class="activity-description">
                            ${clientName} - ${consultation.service_type || 'General Consultation'}
                        </div>
                    </div>
                    <div class="activity-time">${timeAgo}</div>
                </div>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading recent activity:', error);
        activityList.innerHTML = `
            <div class="activity-empty">
                <i class="fas fa-exclamation-circle"></i>
                <p>Error loading activity</p>
            </div>
        `;
    }
}

async function loadRecentRequests() {
    const supabase = window.supabase;
    const caId = window.CA_ID;
    const tableBody = document.getElementById('requestsTableBody');
    
    try {
        // Get pending consultation requests
        const { data: requests, error } = await supabase
            .from('consultations')
            .select(`
                *,
                users!consultations_client_id_fkey (
                    email,
                    first_name,
                    last_name
                )
            `)
            .eq('ca_id', caId)
            .eq('status', 'pending')
            .order('created_at', { ascending: false })
            .limit(5);
        
        if (error) throw error;
        
        if (!requests || requests.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-tertiary);">
                        No pending requests
                    </td>
                </tr>
            `;
            return;
        }
        
        tableBody.innerHTML = requests.map(request => {
            const clientName = request.users?.first_name 
                ? `${request.users.first_name} ${request.users.last_name || ''}`
                : request.users?.email || 'Unknown';
            
            const timeAgo = getTimeAgo(new Date(request.created_at));
            
            return `
                <tr>
                    <td>${clientName}</td>
                    <td>${request.service_type || 'General'}</td>
                    <td>₹${(request.budget || 0).toLocaleString('en-IN')}</td>
                    <td><span class="status-badge pending">Pending</span></td>
                    <td>${timeAgo}</td>
                    <td>
                        <button class="btn btn-ghost" onclick="viewRequest('${request.id}')">
                            View
                        </button>
                    </td>
                </tr>
            `;
        }).join('');
        
    } catch (error) {
        console.error('Error loading recent requests:', error);
        tableBody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: var(--fintech-red);">
                    Error loading requests
                </td>
            </tr>
        `;
    }
}

function setupRealtimeSubscriptions() {
    const supabase = window.supabase;
    const caId = window.CA_ID;
    
    // Subscribe to new consultations
    supabase
        .channel('dashboard-consultations')
        .on('postgres_changes', {
            event: 'INSERT',
            schema: 'public',
            table: 'consultations',
            filter: `ca_id=eq.${caId}`
        }, (payload) => {
            console.log('New consultation:', payload);
            // Reload stats and activity
            loadDashboardStats();
            loadRecentActivity();
            loadRecentRequests();
        })
        .on('postgres_changes', {
            event: 'UPDATE',
            schema: 'public',
            table: 'consultations',
            filter: `ca_id=eq.${caId}`
        }, (payload) => {
            console.log('Consultation updated:', payload);
            // Reload stats and activity
            loadDashboardStats();
            loadRecentActivity();
            loadRecentRequests();
        })
        .subscribe();
}

function getTimeAgo(date) {
    const seconds = Math.floor((new Date() - date) / 1000);
    
    if (seconds < 60) return 'Just now';
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
    return date.toLocaleDateString('en-IN');
}

function viewRequest(requestId) {
    window.location.href = `/ca/clients?request=${requestId}`;
}
</script>
{% endblock %}
